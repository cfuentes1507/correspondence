<odoo>
    <data>
        <!-- Vista Formulario -->
        <record id="correspondence_document_view_form" model="ir.ui.view">
            <field name="name">correspondence_document.form</field>
            <field name="model">correspondence_document</field>
            <field name="arch" type="xml">
                <form string="Documento de Correspondencia">
                    <header>
                        <field name="is_current_user_recipient" invisible="1"/>
                        <field name="already_read_by_my_department" invisible="1"/>
                        
                        <!-- Flujo Interno & Saliente: Borrador -> Firmado -->
                        <button name="action_sign" string="Firmar y Sellar" type="object" class="oe_highlight" attrs="{'invisible': ['|', ('id', '=', False), '|', ('state', '!=', 'draft'), ('correspondence_flow', '=', 'incoming')]}" groups="correspondence.correspondence_group_director"/>
                        
                        <!-- Flujo Interno: Firmado -> Enviado -->
                        <button name="action_send" string="Enviar (Interno)" type="object" class="oe_highlight" attrs="{'invisible': ['|', ('state', '!=', 'signed'), ('correspondence_flow', '!=', 'internal')]}"/>
                        <!-- Flujo Saliente: Firmado -> Despachado -->
                        <button name="action_dispatch" string="Despachar (Externo)" type="object" class="oe_highlight" attrs="{'invisible': ['|', ('state', '!=', 'signed'), ('correspondence_flow', '!=', 'outgoing')]}" groups="correspondence.correspondence_group_external_management"/>
                        <!-- Flujo Entrante: Recibido -> Asignado -->
                        <button name="action_assign" string="Asignar a Departamentos" type="object" class="oe_highlight" attrs="{'invisible': ['|', ('state', '!=', 'received'), ('correspondence_flow', '!=', 'incoming')]}"/>
                        
                        <!-- Botones comunes -->
                        <button name="action_read" string="Marcar como Leído" type="object" class="btn-secondary" attrs="{'invisible': ['|', ('state', 'not in', ['sent', 'assigned']), '|', ('is_current_user_recipient', '=', False), ('already_read_by_my_department', '=', True)]}"/>
                        <button name="action_reply" string="Responder" type="object" class="oe_highlight" attrs="{'invisible': ['|', ('is_current_user_recipient', '=', False), ('state', 'not in', ['sent', 'assigned', 'replied'])]}"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,received,assigned,signed,sent,dispatched,replied"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name" placeholder="Asunto del documento" attrs="{'readonly': [('state', 'not in', ['draft', 'received'])]}"/></h1>
                        </div>
                        <group attrs="{'invisible': [('parent_document_id', '=', False)]}">
                            <field name="parent_document_id" readonly="1"/>
                        </group>
                        <field name="correspondence_flow" invisible="1"/>
                        <group>
                            <group>
                                <field name="correlative" attrs="{'readonly': True}"/>
                                <field name="author_id" invisible="1"/>
                                <!-- Remitente: Interno o Externo -->
                                <field name="send_department_id" readonly="1" attrs="{'invisible': [('correspondence_flow', '=', 'incoming')], 'required': [('correspondence_flow', 'in', ['internal', 'outgoing'])]}"/>
                                <field name="external_partner_id" attrs="{'invisible': [('correspondence_flow', '=', 'internal')], 'required': [('correspondence_flow', 'in', ['incoming', 'outgoing'])], 'readonly': [('state', 'not in', ['draft', 'received'])]}" string="Entidad Externa" context="{'default_is_company': True}"/>
                                <field name="external_address" attrs="{'invisible': [('correspondence_flow', '=', 'internal')]}"/>
                            </group>
                            <group>
                                <field name="date" attrs="{'readonly': [('state', 'not in', ['draft', 'received'])]}"/>
                                <field name="correspondence_type" options="{'no_create': True, 'no_open': True}" attrs="{'readonly': [('state', 'not in', ['draft', 'received'])]}" force_save="1"/>
                                <!-- Destinatario: Interno o Externo -->
                                <field name="recipient_department_ids" string="Departamentos Destinatarios (Internos)"
                                    widget="many2many_tags"
                                    options="{'no_create': True, 'no_open': True}"
                                    attrs="{'invisible': [('correspondence_flow', '=', 'outgoing')], 'required': [('correspondence_flow', 'in', ['internal', 'incoming'])], 'readonly': [('state', 'not in', ['draft', 'received'])]}" 
                                    domain="[('id', '!=', send_department_id)]"/>
                                <!-- Método de envío para correspondencia saliente -->
                                <field name="shipping_method" attrs="{'invisible': [('correspondence_flow', '!=', 'outgoing')], 'required': [('correspondence_flow', '=', 'outgoing')]}"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Descripción">
                                <field name="descripcion" attrs="{'readonly': [('state', 'not in', ['draft', 'received'])]}"/>
                            </page>
                            <page string="Observaciones">
                                <field name="observaciones" attrs="{'readonly': [('state', 'not in', ['draft', 'received'])]}"/>
                            </page>
                            <page string="Adjuntos" name="attachments">
                                <group>
                                    <field string="Documento Firmado" name="document_file" filename="file_name" readonly="1"/>
                                    <field name="file_name" invisible="1"/>
                                    <separator string="Archivos Adicionales"/>
                                    <field name="extra_attachment_ids" widget="many2many_binary" attrs="{'readonly': [('state', 'not in', ['draft', 'received'])]}"/>
                                </group>
                            </page>
                            <page string="Respuestas">
                                <field name="child_document_ids" force_save="1" attrs="{'readonly': ['&amp;', ('state', '!=', 'draft'), ('is_current_user_recipient', '=', False)]}">
                                </field>
                            </page>
                            <page string="Estado de Lectura" name="read_status">
                                <field name="read_status_ids" readonly="1">
                                    <tree><field name="department_id"/><field name="read_by_user_id"/><field name="read_date"/></tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>
        <!-- Vista Kanban -->
        <record id="correspondence_document_view_kanban" model="ir.ui.view">
            <field name="name">correspondence.document.kanban</field>
            <field name="model">correspondence_document</field>
            <field name="arch" type="xml">
                <kanban default_group_by="correspondence_type" class="o_kanban_mobile" group_create="false" default_order="correlative desc">
                    <field name="correlative"/>
                    <field name="name"/>
                    <field name="date"/>
                    <field name="send_department_id"/>
                    <field name="recipient_department_ids"/>
                    <field name="state"/>
                    <field name="user_facing_state"/>
                    <field name="correspondence_type"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click">
                                <div class="o_kanban_record_top mb-2">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <span><t t-out="record.name.value"/></span>
                                        </strong>
                                        <small class="o_kanban_record_subtitle text-muted">
                                            <t t-out="record.correlative.value"/>
                                        </small>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="mb-2">
                                        <i class="fa fa-calendar-o" aria-label="Fecha" title="Fecha"/> <t t-out="record.date.value"/>
                                    </div>
                                    <div class="mb-2">
                                        <i class="fa fa-paper-plane-o" aria-label="Remitente" title="Remitente"/> <t t-out="record.send_department_id.value"/>
                                    </div>
                                    <div class="mb-2">
                                        <i class="fa fa-users" aria-label="Destinatarios" title="Destinatarios"/> <t t-out="record.recipient_department_ids.value"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span class="oe_kanban_list_many2many"><t t-out="record.correspondence_type.value"/></span>
                                    </div>
                                    <div class="oe_kanban_bottom_right"><span t-attf-class="badge #{['draft', 'signed'].indexOf(record.state.raw_value) > -1 ? 'badge-secondary' : 'badge-success' }"><t t-out="record.user_facing_state.value"/></span></div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Vista Kanban HEREDADA para el Archivo. Modifica la vista base para cambiar la acción de clic. -->
        <record id="correspondence_document_view_kanban_archive" model="ir.ui.view">
            <field name="name">correspondence.document.kanban.archive</field>
            <field name="model">correspondence_document</field>
            <field name="inherit_id" ref="correspondence_document_view_kanban"/>
            <field name="mode">primary</field>
            <field name="arch" type="xml">
                <xpath expr="//t[@t-name='kanban-box']" position="replace">
                    <t t-name="kanban-box">
                        <!-- Contenedor principal con posicionamiento relativo y sin desbordamiento -->
                        <div class="oe_kanban_card" style="position: relative; overflow: hidden;">
                            <!-- Contenido visual de la tarjeta -->
                            <div class="o_kanban_record_top mb-2">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title"><span><t t-out="record.name.value"/></span></strong>
                                    <small class="o_kanban_record_subtitle text-muted"><t t-out="record.correlative.value"/></small>
                                </div>
                            </div>
                            <!-- Botón invisible con posicionamiento absoluto que cubre toda la tarjeta -->
                            <button name="action_open_signed_document" type="object" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; border: none; background: transparent; cursor: pointer;"/>
                        </div>
                    </t>
                </xpath>
            </field>
        </record>
        <!-- Vista Árbol -->
        <record id="correspondence_document_view_tree" model="ir.ui.view">
            <field name="name">correspondence_document.tree</field>
            <field name="model">correspondence_document</field>
            <field name="arch" type="xml">
                <tree string="Correspondencia" decoration-info="correspondence_flow == 'internal'" decoration-success="correspondence_flow == 'incoming'" decoration-warning="correspondence_flow == 'outgoing'">
                    <field name="correlative"/>
                    <field name="correspondence_flow" invisible="1"/> <!-- Añadido para que las decoraciones funcionen -->
                    <field name="name"/>
                    <field name="date"/>
                    <field name="send_department_id"/>
                    <field name="recipient_department_ids" widget="many2many_tags"/>
                    <field name="user_facing_state" string="Estado"/>
                </tree>
            </field>
        </record>
        <!-- Vista Búsqueda -->
        <record id="correspondence_document_view_search" model="ir.ui.view">
            <field name="name">correspondence_document.search</field>
            <field name="model">correspondence_document</field>
            <field name="arch" type="xml">
                <search>
                    <separator/>
                    <field name="name" string="Asunto"/>
                    <field name="recipient_department_ids" string="Departamento Destinatario"/>
                    <searchpanel>
                        <field name="state" icon="fa-tasks" select="multi" enable_counters="1"/>
                        <field name="correspondence_type" icon="fa-folder" select="multi" enable_counters="1"/>
                        <field name="send_department_id" icon="fa-building-o" select="multi" enable_counters="1"/>
                        <field name="recipient_department_ids" string="Departamento Destinatario" icon="fa-users" select="multi" enable_counters="1"/>
                    </searchpanel>
                </search>
            </field>
        </record>
    </data>
</odoo>